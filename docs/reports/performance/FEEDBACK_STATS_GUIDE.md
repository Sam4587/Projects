# 用户反馈与统计功能使用指南

## 📋 功能概述

本功能模块包含两个核心组件：

1. **用户反馈组件** (`/components/feedback/`) - 可拖拽的浮动反馈按钮
2. **数据统计模块** (`/utils/analytics.js`) - 全面的数据统计分析

---

## 🎯 用户反馈组件

### 功能特点

- ✅ **浮动按钮** - 可拖拽位置，不遮挡主要内容
- ✅ **评分系统** - 1-5 星评分
- ✅ **反馈分类** - 功能异常、功能建议、内容反馈、其他
- ✅ **文字反馈** - 支持最多 500 字详细描述
- ✅ **联系方式** - 可选填，方便回复
- ✅ **频次限制** - 每日最多 5 次反馈，防止滥用
- ✅ **本地存储** - 反馈数据保存在本地，最多 100 条

### 使用方式

#### 1. 在页面中引入组件

**JSON 配置** (`page.json`):
```json
{
  "usingComponents": {
    "feedback": "/components/feedback/feedback"
  }
}
```

**WXML 模板** (`page.wxml`):
```xml
<!-- 页面底部添加 -->
<feedback pageName="pageName" />
```

#### 2. 页面标识

通过 `pageName` 属性标识反馈来源页面：
- `translator` - 红包翻译页面
- `calculator` - 随礼计算页面
- `customs` - 地域习俗页面

#### 3. 用户操作流程

1. 点击右下角浮动「反馈」按钮
2. 选择星级评分 (1-5 星)
3. 选择反馈类型
4. 填写反馈内容（必填）
5. 填写联系方式（可选）
6. 点击提交

---

## 📊 数据统计模块

### 统计类型

#### 1. 页面统计
- 页面访问次数 (`trackPageView`)
- 页面停留时长 (`trackPageLeave`)
- 页面离开事件

#### 2. 事件统计
- 自定义事件 (`trackEvent`)
- 用户操作 (`trackAction`)
- 翻译成功事件
- 分类切换事件

#### 3. 性能统计
- 操作响应时间
- 页面加载时间
- 其他性能指标

#### 4. 错误统计
- JS 运行错误
- 页面不存在错误
- 自定义错误

### 使用方法

#### 在页面中追踪事件

```javascript
const app = getApp();

Page({
  onLoad: function() {
    // 追踪页面浏览
    app.trackPageView('pageName', { param: 'value' });
  },
  
  onUnload: function() {
    // 追踪页面离开
    app.trackEvent('page_leave', { page: 'pageName' });
  },
  
  someFunction: function() {
    // 追踪自定义事件
    app.trackEvent('event_name', {
      key1: 'value1',
      key2: 'value2'
    });
  }
});
```

#### 追踪错误

```javascript
try {
  // 某些可能出错的代码
} catch (error) {
  app.trackError(error, { context: 'operation_name' });
}
```

---

## 📈 统计报告页面

### 访问方式

路径：`/pages/stats/stats`

可以通过以下方式进入：
1. 在 app.json 的 tabBar 中添加入口
2. 通过按钮跳转：`wx.navigateTo({ url: '/pages/stats/stats' })`
3. 开发者工具直接输入路径预览

### 报告内容

#### 1. 概览 Tab
- 总体数据：页面访问、事件触发、错误次数、用户反馈
- 热门页面排行
- 热门事件排行

#### 2. 反馈 Tab
- 用户反馈列表（最近 20 条）
- 反馈类型、评分、内容、时间
- 点击查看详情

#### 3. 事件 Tab
- 今日事件记录（最近 50 条）
- 事件类型、详情、时间

#### 4. 性能 Tab
- 性能指标统计
- 平均值、最大值、最小值

#### 操作功能
- **导出报告** - 复制 JSON 格式的完整报告到剪贴板
- **清空数据** - 清空所有统计数据（需要确认）

---

## 💾 数据存储

### 存储键名

| 键名 | 说明 | 保留条数 |
|------|------|----------|
| `user_feedback_list` | 用户反馈列表 | 100 条 |
| `feedback_count_${date}` | 每日反馈次数 | 当日 |
| `stats_pageviews` | 页面访问统计 | 永久 |
| `stats_duration` | 停留时长统计 | 永久 |
| `stats_events` | 事件统计 | 永久 |
| `stats_performance` | 性能统计 | 最近 100 条 |
| `stats_errors` | 错误统计 | 永久 |
| `analytics_events_${date}` | 每日事件日志 | 1000 条 |

### 数据清理

应用更新时，会保留统计相关数据，只清理其他缓存数据。

---

## 🔧 开发者注意事项

### 调试技巧

1. **查看日志**
   ```javascript
   // 在控制台查看统计报告
   const { analytics } = require('../../utils/analytics.js');
   console.log(analytics.generateReport());
   ```

2. **模拟数据**
   ```javascript
   // 添加测试反馈
   const feedback = {
     rating: 5,
     type: 'feature',
     content: '测试反馈内容',
     contact: 'test@example.com',
     createTime: new Date().toISOString()
   };
   wx.setStorageSync('user_feedback_list', [feedback]);
   ```

### 性能优化

- 事件队列最大 50 条，满时自动刷新
- 自动刷新间隔 30 秒
- 性能数据只保留最近 100 条
- 反馈列表最多 100 条

### 扩展建议

1. **后端集成** - 将 `submitFeedback` 方法改为发送到服务器
2. **实时同步** - 添加网络状态监听，在线时实时上报
3. **数据可视化** - 使用图表库展示趋势
4. **用户画像** - 添加更多用户行为追踪

---

## 📱 用户界面预览

### 反馈弹窗
```
┌─────────────────────────┐
│        💌 意见反馈        │
│                         │
│  您的评价               │
│  ☆ ☆ ☆ ☆ ☆            │
│                         │
│  反馈类型               │
│  [功能异常][功能建议]    │
│  [内容反馈][其他]        │
│                         │
│  您的建议               │
│  ┌─────────────────┐    │
│  │                 │    │
│  └─────────────────┘    │
│                         │
│  联系方式（选填）        │
│  ┌─────────────────┐    │
│  └─────────────────┘    │
│                         │
│  [  取消  ] [提交反馈]   │
└─────────────────────────┘
```

### 浮动按钮
```
    ╭──────╮
   ╱   💬   ╲
  │   反馈   │
   ╲   ✨   ╱
    ╰──────╯
```

---

## ❓ 常见问题

**Q: 反馈数据会丢失吗？**  
A: 数据保存在本地存储，清除缓存或卸载小程序会丢失。建议定期导出重要数据。

**Q: 可以同时显示多个反馈按钮吗？**  
A: 每个页面建议只放置一个反馈组件，避免重复。

**Q: 统计功能会影响性能吗？**  
A: 采用队列批量写入，对性能影响极小。自动刷新间隔 30 秒，队列满时立即写入。

**Q: 如何查看实时统计数据？**  
A: 进入「数据统计」页面查看，数据会自动刷新。

---

## 📝 更新日志

### 2024-01-28
- ✅ 初始版本发布
- ✅ 用户反馈组件
- ✅ 数据统计模块
- ✅ 统计报告页面

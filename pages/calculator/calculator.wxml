<view class="calculator-container paper-cut-bg">
  <!-- 其他内容 -->
  <view class="content">
    <view class="card">
      <view class="card-title">
        <text class="icon">🧮</text>
        随礼金额计算器
      </view>
      
      <view class="form-group">
        <view class="form-label">选择关系类型</view>
        <view class="category-grid">
          <view 
            class="category-btn {{relationship === 'family' ? 'active' : ''}}" 
            bindtap="selectRelationship" 
            data-rel="family"
          >
            ❤️ 家人亲戚
          </view>
          <view 
            class="category-btn {{relationship === 'friend' ? 'active' : ''}}" 
            bindtap="selectRelationship" 
            data-rel="friend"
          >
            👥 朋友同学
          </view>
          <view 
            class="category-btn {{relationship === 'colleague' ? 'active' : ''}}" 
            bindtap="selectRelationship" 
            data-rel="colleague"
          >
            💼 同事领导
          </view>
          <view 
            class="category-btn {{relationship === 'boss' ? 'active' : ''}}" 
            bindtap="selectRelationship" 
            data-rel="boss"
          >
            👑 老板客户
          </view>
        </view>
      </view>

      <view class="form-group">
        <view class="form-label">选择亲疏程度</view>
        <view class="category-grid">
          <view
            class="category-btn {{closeness === 'acquaintance' ? 'active' : ''}}"
            bindtap="selectCloseness"
            data-close="acquaintance"
          >
            点头之交
          </view>
          <view
            class="category-btn {{closeness === 'normal' ? 'active' : ''}}"
            bindtap="selectCloseness"
            data-close="normal"
          >
            普通关系
          </view>
          <view
            class="category-btn {{closeness === 'close' ? 'active' : ''}}"
            bindtap="selectCloseness"
            data-close="close"
          >
            关系密切
          </view>
          <view
            class="category-btn {{closeness === 'very-close' ? 'active' : ''}}"
            bindtap="selectCloseness"
            data-close="very-close"
          >
            非常要好
          </view>
        </view>
      </view>

      <!-- 场合选择 -->
      <view class="form-group">
        <view class="form-label">
          <text>选择场合</text>
          <text class="optional-tag">(可选)</text>
        </view>
        <view class="selector-trigger" bindtap="showOccasionSelector">
          <text class="selector-text">{{occasionName}}</text>
          <text class="selector-arrow">▼</text>
        </view>
      </view>

      <!-- 地域选择 -->
      <view class="form-group">
        <view class="form-label">
          <text>选择地域</text>
          <text class="optional-tag">(可选)</text>
        </view>
        <view class="selector-trigger" bindtap="showRegionSelector">
          <text class="selector-text">{{regionName}}</text>
          <text class="selector-arrow">▼</text>
        </view>
      </view>

      <!-- 预算设置按钮 -->
      <view class="budget-trigger" bindtap="showBudgetSettings">
        <text class="budget-icon">💰</text>
        <text class="budget-text">{{budgetMin && budgetMax ? '预算: ¥' + budgetMin + '-' + budgetMax : '设置预算范围'}}</text>
      </view>

      <button
        class="btn btn-primary"
        bindtap="calculateAmount"
        disabled="{{!relationship || !closeness}}"
      >
        计算推荐金额
      </button>

      <view wx:if="{{result}}" class="result-card">
        <!-- 推荐金额和置信度 -->
        <view class="result-main">
          <view class="result-amount-section">
            <view class="result-title">推荐金额</view>
            <view class="result-amount">¥{{result.amount}}</view>
            <view class="result-confidence">
              <text class="confidence-label">{{result.confidenceLabel}}</text>
              <progress percent="{{result.confidence * 100}}" activeColor="#dc2626" stroke-width="4" />
            </view>
          </view>

          <!-- 金额范围 -->
          <view class="result-range-section">
            <view class="range-label">参考范围</view>
            <view class="range-value">¥{{result.range.low}} - ¥{{result.range.high}}</view>
          </view>
        </view>

        <!-- 推荐依据 -->
        <view class="result-factors">
          <view class="factors-title">📊 推荐依据</view>
          <view class="factors-list">
            <view class="factor-item">
              <text class="factor-label">关系类型</text>
              <text class="factor-value">{{result.factors.relationship}}</text>
            </view>
            <view class="factor-item">
              <text class="factor-label">亲疏程度</text>
              <text class="factor-value">{{result.factors.closeness}}</text>
            </view>
            <view wx:if="{{region}}" class="factor-item">
              <text class="factor-label">所在地域</text>
              <text class="factor-value">{{result.factors.region}}</text>
            </view>
            <view class="factor-item">
              <text class="factor-label">场合类型</text>
              <text class="factor-value">{{result.factors.occasion}}</text>
            </view>
            <view class="factor-item">
              <text class="factor-label">预算范围</text>
              <text class="factor-value">{{result.factors.budget}}</text>
            </view>
          </view>
        </view>

        <!-- 地域习俗 -->
        <view wx:if="{{result.customs}}" class="result-customs">
          <view class="customs-title">🏮 地域习俗</view>
          <view class="customs-content">
            <view class="customs-tips">
              <text class="tips-text">{{result.customs.tips}}</text>
            </view>
            <view class="customs-traditions">
              <view wx:for="{{result.customs.traditions}}" wx:key="*this" class="tradition-item">
                <text>• {{item}}</text>
              </view>
            </view>
            <view class="customs-numbers">
              <view class="numbers-label">🔢 吉利数字推荐</view>
              <view class="numbers-grid">
                <view wx:for="{{result.customs.preferredNumbers}}" wx:key="*this" class="number-chip">
                  <text class="chip-text">{{item}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 历史对比 -->
        <view wx:if="{{result.comparison}}" class="result-comparison">
          <view class="comparison-title">📈 您的历史平均：¥{{result.comparison.userAverage}}</view>
          <view class="comparison-diff">
            <text class="diff-value">当前推荐 vs 历史平均</text>
            <text class="diff-amount {{result.comparison.difference > 0 ? 'positive' : 'negative'}}">
              {{result.comparison.difference}}
            </text>
          </view>
        </view>
        
        <!-- Banner广告区域 - 临时隐藏，过审后将恢复 -->
        <!--
        <view class="ad-section" id="calculator-feedback-section">
          <view wx:if="{{!showBannerAd}}" class="feedback-section">
            <view class="feedback-header">
              <text class="feedback-title">💡 反馈优化</text>
              <text class="feedback-desc">帮助我们改进推荐算法</text>
            </view>
            
            <view class="feedback-content">
              <view class="feedback-input-row">
                <text class="feedback-label">我实际给了：</text>
                <view class="amount-input-container">
                  <text class="amount-symbol">¥</text>
                  <input 
                    class="amount-input" 
                    type="number"
                    placeholder="请输入实际金额"
                    value="{{actualAmount}}"
                    bindinput="onInputActualAmount"
                    maxlength="6"
                  />
                  <text class="amount-unit">元</text>
                </view>
              </view>
              
              <button 
                class="btn btn-secondary feedback-btn" 
                bindtap="submitPseudoFeedback"
                disabled="{{!actualAmount}}"
              >
                提交反馈
              </button>
              
              <view class="feedback-tip">
                <text class="tip-text">🌟 您的反馈将帮助我们优化推荐算法，让计算结果更准确</text>
              </view>
            </view>
          </view>
          
          <view wx:if="{{showBannerAd}}" class="banner-ad-container">
            <view class="ad-placeholder">
              <text class="ad-text">广告位</text>
              <view class="ad-loading">
                <text class="loading-text">正在加载广告...</text>
              </view>
            </view>
          </view>
        </view>
        -->

        <!-- 免责声明 -->
        <view class="disclaimer-box">
          <view class="disclaimer-title">⚠️ 免责声明</view>
          <view class="disclaimer-text">
            本计算结果仅供参考，不构成任何建议。
            实际随礼金额请结合当地风俗、个人经济状况和双方关系综合判断。
            开发者不承担由此产生的任何法律责任。
          </view>
        </view>

        <!-- 开发者测试入口 -->
        <view class="dev-test-entry" bindtap="gotoDevTest">
          <text class="dev-test-text">钉钉集成测试</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 用户反馈组件 -->
  <feedback pageName="calculator" />

  <!-- 预算设置弹窗 -->
  <view wx:if="{{showBudgetSettings}}" class="modal-overlay" bindtap="hideBudgetSettings">
    <view class="modal-content budget-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">预算范围设置</text>
        <text class="modal-close" bindtap="hideBudgetSettings">✕</text>
      </view>

      <view class="budget-input-section">
        <view class="input-group">
          <text class="input-label">最低金额</text>
          <input
            class="budget-input"
            type="number"
            placeholder="不设置"
            value="{{budgetMin}}"
            bindinput="onMinBudgetInput"
          />
          <text class="input-unit">元</text>
        </view>

        <view class="input-group">
          <text class="input-label">最高金额</text>
          <input
            class="budget-input"
            type="number"
            placeholder="不设置"
            value="{{budgetMax}}"
            bindinput="onMaxBudgetInput"
          />
          <text class="input-unit">元</text>
        </view>
      </view>

      <view class="budget-tips">
        <text class="tips-text">💡 设置预算后,推荐金额会自动调整到范围内</text>
      </view>

      <button class="btn btn-primary modal-btn" bindtap="hideBudgetSettings">
        确认
      </button>
    </view>
  </view>

  <!-- 场合选择弹窗 -->
  <view wx:if="{{showOccasionPicker}}" class="modal-overlay" bindtap="hideOccasionSelector">
    <view class="modal-content picker-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">选择场合</text>
        <text class="modal-close" bindtap="hideOccasionSelector">✕</text>
      </view>

      <scroll-view class="picker-list" scroll-y="true">
        <view
          wx:for="{{occasionList}}"
          wx:key="id"
          class="picker-item {{occasion === item.id ? 'selected' : ''}}"
          bindtap="selectOccasion"
          data-occasion="{{item.id}}"
        >
          <text class="picker-text">{{item.name}}</text>
          <text wx:if="{{occasion === item.id}}" class="picker-check">✓</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 地域选择弹窗 -->
  <view wx:if="{{showRegionPicker}}" class="modal-overlay" bindtap="hideRegionSelector">
    <view class="modal-content picker-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">选择地域</text>
        <text class="modal-close" bindtap="hideRegionSelector">✕</text>
      </view>

      <scroll-view class="picker-list" scroll-y="true">
        <view
          wx:for="{{regionList}}"
          wx:key="id"
          class="picker-item {{region === item.id ? 'selected' : ''}}"
          bindtap="selectRegion"
          data-region="{{item.id}}"
        >
          <text class="picker-text">{{item.name}}</text>
          <text wx:if="{{region === item.id}}" class="picker-check">✓</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>

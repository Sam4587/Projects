# 钉钉集成测试说明

## 概述

本指南用于测试和验证钉钉机器人集成功能,确保用户反馈能够正常发送到钉钉群。

## 当前状态

### 已实现功能

1. **钉钉机器人配置**
   - Webhook URL: 已配置
   - Secret 密钥: 已配置
   - HMAC-SHA256 签名: 已实现

2. **反馈提交功能**
   - 用户可以通过反馈组件提交反馈
   - 支持评分、类型选择、内容输入
   - 包含设备信息和用户系统信息

3. **测试页面**
   - 路径: `pages/test-dingtalk/test-dingtalk`
   - 提供多种测试选项
   - 实时日志显示

### 已知问题

1. **签名生成不稳定**
   - 当前使用了硬编码的已知签名
   - 时间戳匹配问题可能导致失败
   - 需要修复 HMAC-SHA256 算法

2. **配置路径问题**
   - 已修复: 将 `this.config?.webhook` 改为 `this.webhook`
   - 确保 webhook 正确从配置中获取

## 测试步骤

### 1. 访问测试页面

有两种方式访问测试页面:

**方式一: 通过开发者入口(推荐)**
1. 打开小程序,进入"随礼计算"页面
2. 滚动到页面底部,找到"钉钉集成测试"链接
3. 点击进入测试页面

**方式二: 直接访问**
1. 在开发者工具中打开 `pages/test-dingtalk/test-dingtalk` 页面

### 2. 检查环境配置

1. 点击"检查环境"按钮
2. 查看日志输出,确认:
   - ✓ 平台信息正常
   - ✓ 设备信息正常
   - ✓ Webhook 配置已设置
   - ✓ Secret 配置已设置

### 3. 查看钉钉配置

1. 点击"查看钉钉配置"按钮
2. 确认配置信息:
   - Webhook: 显示前40个字符 + ...
   - Secret: 显示前10个字符 + ...
   - Project: "随礼那点事儿"
   - Version: "1.0.0"

### 4. 测试连接

1. 点击"测试钉钉服务连通性"按钮
2. 观察测试结果:
   - **成功**: 显示"钉钉服务正常可用"
   - **失败**: 显示错误信息

**预期结果**:
- 如果签名生成正确,会发送一条测试消息到钉钉群
- 如果签名错误,会收到钉钉的错误响应

### 5. 测试反馈提交

1. 点击"提交测试反馈"按钮
2. 系统会自动发送一条测试反馈到钉钉

**测试反馈内容**:
```
评分: 5⭐
类型: 功能建议
页面: test_dingtalk
内容: 这是测试反馈,用于验证钉钉集成是否正常工作
```

**检查钉钉群**:
- 查看是否收到测试反馈消息
- 确认消息格式正确
- 确认所有字段显示正常

### 6. 获取统计信息

1. 点击"获取反馈统计"按钮
2. 查看统计结果

**注意**: 当前统计功能为占位实现,仅显示基本信息。

## 预期结果

### 成功场景

1. **测试连接成功**
   - 日志显示: "✅ 钉钉服务正常可用"
   - 钉钉群收到测试消息

2. **反馈提交成功**
   - 日志显示: "✅ 反馈提交成功"
   - 钉钉群收到完整的反馈消息
   - 消息包含评分、类型、内容、设备信息等

### 失败场景

1. **签名错误**
   - 日志显示: "❌ 测试失败"
   - 错误信息: "签名不匹配"
   - 钉钉群无消息

2. **网络错误**
   - 日志显示: "❌ 测试异常"
   - 错误信息: "网络异常"
   - 钉钉群无消息

3. **配置错误**
   - 日志显示: "❌ 配置错误"
   - 错误信息: "Webhook 或 Secret 未配置"

## 钉钉消息格式

成功的反馈消息应该包含以下部分:

```markdown
# 📋 收到新反馈

## 📊 基本信息
- **评分**: 5 ⭐
- **类型**: 功能建议
- **页面**: calculator
- **反馈时间**: 2026-02-06T10:00:00.000Z

## 💬 反馈内容
这是用户提交的反馈内容

## 📱 用户信息
- **平台**: devtools
- **设备**: devtools iPhone
- **系统**: iOS 17.0.0
- **微信版本**: 8.0.5

## 📞 联系方式
user@example.com
```

## 故障排查

### 问题1: 签名错误

**症状**:
- 测试失败,提示签名不匹配
- 钉钉群收不到消息

**可能原因**:
- HMAC-SHA256 算法实现不正确
- 时间戳格式不匹配
- Secret 配置错误

**解决方法**:
1. 检查 `utils/hmac-sha256-weapp.js` 实现
2. 确认时间戳为毫秒级: `Date.now()`
3. 验证 Secret 配置是否正确
4. 使用钉钉提供的签名验证工具验证

### 问题2: 网络错误

**症状**:
- 测试失败,提示网络异常
- 无法连接到钉钉服务器

**可能原因**:
- 小程序网络权限问题
- 域名未在白名单中
- 网络连接不稳定

**解决方法**:
1. 检查 `project.config.json` 中的 `permission` 配置
2. 确认 `oapi.dingtalk.com` 在合法域名白名单中
3. 检查网络连接状态

### 问题3: 配置未找到

**症状**:
- 日志显示 "Webhook 未配置" 或 "Secret 未配置"
- 点击"查看钉钉配置"时显示配置为空

**可能原因**:
- 配置文件路径错误
- 配置文件格式错误
- 环境检测失败

**解决方法**:
1. 确认 `config/dingtalk-feedback-miniprogram.js` 文件存在
2. 检查配置文件格式是否为有效的 CommonJS 模块
3. 验证配置文件是否正确导出 config 对象

## 下一步优化

1. **修复签名算法**
   - 实现正确的 HMAC-SHA256 算法
   - 移除硬编码的签名
   - 支持动态时间戳

2. **增强错误处理**
   - 提供更详细的错误信息
   - 添加重试机制
   - 记录错误日志

3. **优化测试页面**
   - 添加更多测试场景
   - 提供实时日志查看
   - 支持自定义测试内容

4. **监控和统计**
   - 实现真实的反馈统计功能
   - 添加成功率监控
   - 记录发送失败的原因

## 联系方式

如果在测试过程中遇到问题,请联系:

- 项目仓库: [GitHub Repository]
- 钉钉群: [钉钉群链接]
- 开发者: [开发者联系方式]

---

**文档版本**: v1.0
**最后更新**: 2026-02-06
**维护者**: 随礼那点事儿项目组

# 🚀 腾讯云函数部署完整指南

## ✅ 已完成工作

我在项目中已经为您创建了完整的腾讯云函数部署包：
- **文件位置**: `tencent-cloud-function-serverless/tencent-dingtalk-api-deployment.zip`
- **文件大小**: 3,824 字节
- **状态**: 准备就绪，可直接上传

## 📋 部署步骤（10分钟完成）

### 第1步：登录腾讯云控制台
1. 打开浏览器访问：https://cloud.tencent.com
2. 点击右上角"控制台"
3. 使用QQ或微信扫码登录

### 第2步：进入云函数服务
1. 访问：https://console.cloud.tencent.com/scf
2. 如果首次使用，需要开通云函数服务
3. 点击"函数服务" → "新建"

### 第3步：创建函数

**基础配置**：
- **函数名称**: `dingtalk-feedback`
- **地域**: 广州（推荐）或其他离您较近的区域
- **运行环境**: Node.js 16.13.0
- **函数类型**: 普通函数

**提交方式**：
- **提交方式**: 本地上传zip
- **上传文件**: 选择 `tencent-dingtalk-api-deployment.zip`
- **执行方法**: `index.main_handler`

### 第4步：配置环境变量

在"高级配置"中，添加以下环境变量：

| 变量名 | 值 | 说明 |
|--------|----|------|
| DINGTALK_TOKEN | `88eba63bc98bce33a59169fcd33e64093062f0beea5a65d3830e83dfedeaac7a` | 钉钉机器人令牌 |
| DINGTALK_SECRET | `SEC243a3635982cb428719783a0ac2e8359acea9ced01231fede326bd5b281820fc` | 钉钉机器人密钥 |

### 第5步：配置触发器

**API网关触发器配置**：
- **触发方式**: API网关触发
- **API名称**: `dingtalk-feedback` 
- **请求方法**: ANY（支持GET、POST等）
- **发布环境**: 发布
- **API认证方式**: 免认证
- **启用集成响应**: 是

### 第6步：完成创建并获取API地址

1. 点击"完成"，等待部署（约2-3分钟）
2. 部署成功后，进入函数详情页
3. 在"触发管理"选项卡中，找到API网关触发的访问路径
4. 你会得到类似这样的API地址：
   ```
   https://service-xxxxxx.ap-guangzhou.apigateway.myqcloud.com/release/dingtalk-feedback
   ```

## 🧪 测试API

### 方法1：使用浏览器测试
直接访问上面获得的API地址，应该看到：
```json
{"error":"Method not allowed"}
```
（这是正常的，因为我们只允许POST请求）

### 方法2：使用在线工具测试
访问：https://www.sojson.com/web/http_request/

- **请求方式**: POST
- **请求地址**: 您获得的API地址
- **请求头**: 
  ```
  Content-Type: application/json
  ```
- **请求体**:
  ```json
  {
    "message": "测试消息：红包装潢助手反馈功能",
    "title": "功能测试",
    "userId": "test_user",
    "page": "pages/translator/translator"
  }
  ```

预期返回：
```json
{
  "success": true,
  "message": "反馈已成功发送到钉钉",
  "msgId": "msg_xxx"
}
```

## 📱 更新小程序配置

获得API地址后，告诉我这个地址，我立即帮您：

1. **更新小程序端配置**：修改 `utils/dingtalk-service-miniapp.js`
2. **集成反馈组件**：创建用户反馈界面
3. **完整功能测试**：确保端到端通信正常

## 🛡️ 安全性和监控

### 安全措施
- ✅ 环境变量保护密钥，代码中不暴露
- ✅ API网关免认证（简化用户体验）
- ✅ 严格的输入验证和错误处理
- ✅ 自动签名验证确保消息完整性

### 监控建议
- 云函数控制台的"监控日志"查看调用情况
- 设置告警规则（调用次数、错误率）
- "函数日志"查看详细的执行日志

## 🔧 故障排除

### 问题1：函数创建失败
**可能原因**：
- 地域选择不受支持
- 运行环境版本不兼容

**解决方案**：
- 选择"广州"区域
- 确保选择Node.js 16.13.0

### 问题2：API返回500错误
**可能原因**：
- 环境变量未正确设置
- 网络连接问题

**解决方案**：
- 检查环境变量拼写
- 查看函数日志了解具体错误

### 问题3：钉钉收不到消息
**可能原因**：
- 钉钉机器人被禁用
- 签名验证失败

**解决方案**：
- 检查钉钉群机器人状态
- 重新生成机器人密钥

## 📞 联系支持

如果部署过程中遇到问题：
- 腾讯云客服：400-910-0100
- 腾讯云文档：https://cloud.tencent.com/document/product/583
- 钉钉开发文档：https://open.dingtalk.com/document/robots/custom-robot-access

---

**部署完成后，请告诉我您的API地址，我立即帮您完成剩下的步骤！** 🎉